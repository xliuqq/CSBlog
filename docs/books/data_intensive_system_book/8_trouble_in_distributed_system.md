# 分布式系统的麻烦

使用分布式系统与在一台计算机上编写软件有着根本的区别，主要的区别在于，有许多新颖和刺激的方法可以使事情出错【1,2】。

本章对分布式系统中可能出现的问题进行彻底的悲观和沮丧的总结。我们将研究网络的问题（“[不可靠的网络](#不可靠的网络)”）; 时钟和时序问题（“[不可靠的时钟](#不可靠的时钟)”）。



## 故障与部分失效

单个计算机上的软件没有根本性的不可靠原因：

- 硬件正常工作时，相同的操作总是产生相同的结果（这是确定性的）
- 存在硬件问题（例如，内存损坏或连接器松动），其后果通常是整个系统故障（例如，内核恐慌，“蓝屏死机”，启动失败）

从第一台数字计算机开始，*始终正确地计算* 这个设计目标贯穿始终【3】。

- 计算机设计中的一个有意的选择：如果发生内部错误，我们宁愿电脑完全崩溃，而不是返回错误的结果

而在现实世界中，各种各样的事情都可能会出现问题【4】。

**部分失效（partial failure）**：分布式系统中，系统的某些部分可能会以某种不可预知的方式被破坏。

- 部分失效是 **不确定性的（nondeterministic）**
  - 任何涉及多个节点和网络的事情，它有时可能会工作，有时会出现不可预知的失败；甚至不知道是否成功，网络传播时间也是不确定的；

这种不确定性和部分失效的可能性，使得分布式系统难以工作【5】。

### 云计算与超级计算机

如何构建大型计算系统有一系列的哲学：

- 一个极端是高性能计算（HPC）领域：通常用于计算密集型科学计算任务，如天气预报或分子动力学（模拟原子和分子的运动）
- 另一个极端是 **云计算（cloud computing）**【6】：通常与多租户数据中心，以太网连接的商用计算机，弹性 / 按需资源分配以及计量计费等相关联；

不同的哲学会导致不同的故障处理方式：

- **超级计算机**：通过让**部分失败升级为完全失败来处理部分失败**
  - 作业通常会不时地将计算的状态存盘到持久存储中，单个节点故障后，重新启动工作负载从上一个检查点开始【7，8】；
  - 超级计算机更像是一个单节点计算机而不是分布式系统

本书的重点放在实现互联网服务的系统上，与超级计算机看起来有很大不同：

- 可用性：互联网服务要求低延迟，服务不可用（如停止集群进行修复）是不可接受；像天气模拟这样离线（批处理）工作可以重新启动；
- 硬件：超级计算机由专用硬件构成，节点相当可靠，节点间通过共享内存和远程直接内存访问进行通信；云服务是商用机器构建而成，以较低程本提供相同性能，且具有较高的故障率；
- 网络：超级计算机通常使用专门的网络拓扑结构（如多维网格和Torus网络【10】）；互联网通常基于IP和以太网，以 CLOS 拓扑排列，提供更高的对分（bisection）带宽【9】；
- 位置：超级计算机通常假设所有节点都在一起，而互联网可以是地理位置分散部署，与本地网络相比，通信速度缓慢且不可靠；
- 故障处理：成千上万的节点的系统中，可以认为总会有一些东西是坏掉的【7】。如果错误处理策略只是简单放弃组成时，一个大的系统最终会花费大量时间从错误中恢复，而不是做有用的工作【8】。

> #### 从不可靠的组件构建可靠的系统
>
> 直观地看来，系统只能像其最不可靠的组件（最薄弱的环节）一样可靠。但事实上，从不太可靠的潜在基础构建更可靠的系统是计算机领域的一个古老思想【11】：
>
> - 纠错码允许数字数据在通信信道上准确传输，偶尔会出现一些错误，例如由于无线网络上的无线电干扰【12】
>
> - **互联网协议（Internet Protocol, IP）** 不可靠：可能丢弃、延迟、重复或重排数据包。传输控制协议（Transmission Control Protocol, TCP）在互联网协议（IP）之上提供了更可靠的传输层。
>
> 虽然这个系统可以比它的底层部分更可靠，但它的可靠性总是有限的。
>
> - 纠错码可以处理少量的单比特错误，但是如果你的信号被干扰所淹没，那么通过信道可以得到多少数据，是有根本性的限制的【13】
> - TCP 可以隐藏数据包的丢失，重复和重新排序，但是它不能神奇地消除网络中的延迟。
>
> 虽然更可靠的高级系统并不完美，但它仍然有用，因为它处理了一些棘手的低级错误，所以其余的错误通常更容易推理和处理。我们将在 “[数据库的端到端原则](./12_the_future.md#数据库的端到端原则)” 中进一步探讨这个问题。

## 不可靠的网络

本书中关注的**分布式系统是无共享的系统**，即通过网络连接的一堆机器。

互联网和数据中心（通常是以太网）中的大多数内部网络都是 **异步分组网络（asynchronous packet networks）**

- 一个节点可以向另一个节点发送一个消息（一个数据包），但是网络不能保证它什么时候到达，或者是否到达
- 发送请求并期待响应，则很多事情可能会出错（其中一些如 [图 8-1](https://github.com/Vonng/ddia/blob/master/img/fig8-1.png) 所示）：
  - 请求可能已经丢失（可能有人拔掉了网线）。
  - 请求可能正在排队，稍后将交付（也许网络或接收方过载）。
  - 远程节点可能已经失效（可能是崩溃或关机）。
  - 远程节点可能暂时停止了响应（可能会遇到长时间的垃圾回收暂停；请参阅 “[进程暂停](#进程暂停)”），但稍后会再次响应。
  - 远程节点可能已经处理了请求，但是网络上的响应已经丢失（可能是网络交换机配置错误）。
  - 远程节点可能已经处理了请求，但是响应已经被延迟，并且稍后将被传递（可能是网络或者你自己的机器过载）。

**图 8-1 如果发送请求并没有得到响应，则无法区分（a）请求是否丢失，（b）远程节点是否关闭，或（c）响应是否丢失。**

![img](pics/fig8-1.png)

发送者不能分辨数据包是否被发送，不能确认接收者是否已经处理：

- 处理这个问题的通常方法是 **超时（Timeout）**：在一段时间之后放弃等待，并且认为响应不会到达。
- 导致：消息被发送多次，或者被处理多次；

### 真实世界的网络故障

